<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard — Traqr Cloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet" />
  <link href="/css/output.css" rel="stylesheet" />
</head>
<body class="min-h-screen bg-ink-100">
  <div class="flex min-h-screen">
    <!-- Sidebar: on mobile fixed and off-screen until opened -->
    <aside id="dashboard-sidebar" class="fixed inset-y-0 left-0 z-40 flex w-64 shrink-0 flex-col border-r border-ink-200 bg-white px-4 py-6 transition-transform duration-200 -translate-x-full sm:relative sm:translate-x-0" aria-label="Main navigation">
      <a href="/" class="mb-8 inline-flex items-center gap-2 text-ink-900">
        <img src="/traqr.png" alt="Traqr" class="h-8 w-auto" />
        <span class="text-sm font-medium text-ink-600">Cloud</span>
      </a>
      <nav class="space-y-1 text-sm">
        <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Main</div>
        <a href="/dashboard" class="mt-1 flex items-center justify-between rounded-lg bg-ink-900 px-3 py-2 font-medium text-white">
          <span>Overview</span>
        </a>
        <div class="mt-4 text-xs font-semibold uppercase tracking-wide text-ink-500">Operations</div>
        <a href="/organizations" class="mt-1 block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Organizations &amp; Stores</a>
        <a href="/ops-devices" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Devices &amp; Activation</a>
        <a href="/ops-menus" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Menus &amp; Availability</a>
        <a href="/ops-orders" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Orders &amp; Receipts</a>
        <a href="/ops-commands" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Command Center</a>
        <div id="sa-nav" class="mt-4 hidden">
          <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Traqr team</div>
          <a href="/super-admin" class="mt-1 block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Super Admin</a>
        </div>
        <div id="blog-nav" class="mt-4 hidden">
          <a href="/blog" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Blog</a>
          <a href="/blog/new" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">New post</a>
        </div>
        <div id="docs-nav" class="mt-4 hidden">
          <a href="/docs" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Docs</a>
          <a href="/docs/new" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">New doc</a>
        </div>
        <a href="/docs" id="docs-link-visible" class="mt-4 block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100 sm:hidden">Docs</a>
        <a href="/profile" class="mt-4 block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">My profile</a>
      </nav>
      <div class="mt-auto pt-6 text-xs text-ink-500">
        Logged in as <span id="user-name">Demo Admin</span>
      </div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 min-w-0">
      <!-- Top bar for mobile -->
      <header class="flex items-center justify-between border-b border-ink-200 bg-white px-4 py-3 sm:hidden">
        <button type="button" id="dashboard-mobile-menu-btn" class="rounded p-2 text-ink-600 hover:bg-ink-100" aria-label="Open menu">&#9776;</button>
        <a href="/" class="inline-flex items-center gap-2 text-ink-900">
          <img src="/traqr.png" alt="Traqr" class="h-7 w-auto" />
          <span class="text-sm font-medium text-ink-600">Cloud</span>
        </a>
        <span id="user-name-mobile" class="text-xs text-ink-500">Demo Admin</span>
      </header>
      <div id="dashboard-sidebar-overlay" class="fixed inset-0 z-30 hidden bg-black/50 sm:hidden" aria-hidden="true"></div>
      <div id="dashboard-toast" class="mx-4 mt-4 hidden rounded-lg border px-4 py-3 text-sm sm:mx-6 lg:mx-8" role="alert"></div>

      <div class="mx-auto max-w-6xl px-4 py-6 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between gap-4">
          <div>
            <h1 class="font-display text-2xl font-bold text-ink-900">Overview</h1>
            <p class="mt-1 text-sm text-ink-600">
              Snapshot of orders, revenue, and device activity from synced POS data.
            </p>
            <p id="cloud-membership-status" class="mt-1 text-xs text-ink-500">
              Cloud membership: checking…
            </p>
          </div>
          <button id="refresh-btn" class="btn-secondary text-sm">Refresh</button>
        </div>

        <!-- Metrics -->
        <section class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4" aria-label="Key metrics">
          <div class="card">
            <p class="text-xs font-medium uppercase tracking-wide text-ink-500">Total orders</p>
            <p id="metric-total-orders" class="mt-2 text-2xl font-semibold text-ink-900">–</p>
          </div>
          <div class="card">
            <p class="text-xs font-medium uppercase tracking-wide text-ink-500">Today</p>
            <p id="metric-today-orders" class="mt-2 text-2xl font-semibold text-ink-900">–</p>
          </div>
          <div class="card">
            <p class="text-xs font-medium uppercase tracking-wide text-ink-500">Total revenue</p>
            <p id="metric-total-revenue" class="mt-2 text-2xl font-semibold text-ink-900">–</p>
          </div>
          <div class="card">
            <p class="text-xs font-medium uppercase tracking-wide text-ink-500">Devices</p>
            <p id="metric-device-count" class="mt-2 text-2xl font-semibold text-ink-900">–</p>
            <p id="metric-last-event" class="mt-1 text-xs text-ink-500">Last event: –</p>
          </div>
        </section>

        <!-- Recent orders -->
        <section class="mt-8" aria-label="Recent orders">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-ink-900">Recent orders</h2>
            <p id="orders-count" class="text-xs text-ink-500"></p>
          </div>
          <div class="mt-3 overflow-hidden rounded-xl border border-ink-200 bg-white">
            <table class="min-w-full divide-y divide-ink-100 text-sm">
              <thead class="bg-ink-50">
                <tr>
                  <th class="px-4 py-2 text-left font-medium text-ink-600">Order</th>
                  <th class="px-4 py-2 text-left font-medium text-ink-600">Store</th>
                  <th class="px-4 py-2 text-left font-medium text-ink-600">Status</th>
                  <th class="px-4 py-2 text-right font-medium text-ink-600">Total</th>
                  <th class="px-4 py-2 text-left font-medium text-ink-600">Occurred at</th>
                </tr>
              </thead>
              <tbody id="orders-tbody" class="divide-y divide-ink-100 bg-white">
              </tbody>
            </table>
            <div id="orders-empty" class="hidden px-4 py-6 text-center text-xs text-ink-500">
              No orders yet. Once POS devices sync, they will appear here.
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    function formatMoney(cents) {
      if (cents == null) return '–';
      const value = (cents / 100).toFixed(2);
      return '£' + value;
    }
    function formatFriendlyDateTime(value) {
      if (!value) return '–';
      const d = new Date(value);
      if (isNaN(d.getTime())) return value;
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const day = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const time = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true });
      const dateStr = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: d.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
      if (day.getTime() === today.getTime()) return 'Today ' + time;
      if (day.getTime() === yesterday.getTime()) return 'Yesterday ' + time;
      return dateStr + ', ' + time;
    }

    function setUserName(name) {
      document.getElementById('user-name').textContent = name;
      document.getElementById('user-name-mobile').textContent = name;
    }

    async function loadCloudStatus() {
      const el = document.getElementById('cloud-membership-status');
      if (!el) return;
      try {
        const res = await fetch('/api/portal/orgs');
        if (!res.ok) throw new Error('Failed to load orgs');
        const data = await res.json();
        const orgs = data.organizations || [];
        if (orgs.length === 0) {
          el.textContent = 'Cloud membership: set up your first organisation to enable cloud sync.';
          return;
        }
        const anyActive = orgs.some(o => o.cloud_sync_active);
        if (anyActive) {
          el.textContent = 'Cloud membership: active.';
          el.className = 'mt-1 text-xs text-emerald-700';
        } else {
          el.innerHTML = 'Cloud membership: not active. <a href="/pricing" class="text-traqr-600 hover:underline">Start cloud membership</a>.';
          el.className = 'mt-1 text-xs text-ink-600';
        }
      } catch (err) {
        console.error(err);
        el.textContent = 'Cloud membership: unable to check status.';
        el.className = 'mt-1 text-xs text-ink-500';
      }
    }

    async function loadSummary() {
      const res = await fetch('/api/portal/dashboard/summary');
      if (!res.ok) throw new Error('Failed to load summary');
      const data = await res.json();
      document.getElementById('metric-total-orders').textContent = data.total_orders.toLocaleString();
      document.getElementById('metric-today-orders').textContent = data.today_orders.toLocaleString();
      document.getElementById('metric-total-revenue').textContent = formatMoney(data.total_revenue_cents);
      document.getElementById('metric-device-count').textContent = data.device_count.toString();
      document.getElementById('metric-last-event').textContent =
        'Last event: ' + (data.last_event_at ? formatFriendlyDateTime(data.last_event_at) : '–');
    }

    async function loadRecentOrders() {
      const res = await fetch('/api/portal/orders/recent');
      if (!res.ok) throw new Error('Failed to load orders');
      const data = await res.json();
      const orders = data.orders || [];
      const tbody = document.getElementById('orders-tbody');
      const empty = document.getElementById('orders-empty');
      tbody.innerHTML = '';
      if (orders.length === 0) {
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        document.getElementById('orders-count').textContent = orders.length + ' recent orders';
        for (const o of orders) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-4 py-2 font-mono text-xs text-ink-700">${o.local_order_id}</td>
            <td class="px-4 py-2 text-ink-800">${o.store_name}</td>
            <td class="px-4 py-2 text-xs">
              <span class="inline-flex rounded-full px-2 py-0.5 text-[11px] font-medium ${
                o.status === 'open'
                  ? 'bg-amber-50 text-amber-800'
                  : o.status === 'closed'
                  ? 'bg-emerald-50 text-emerald-800'
                  : 'bg-slate-100 text-slate-700'
              }">${o.status}</span>
            </td>
            <td class="px-4 py-2 text-right tabular-nums text-ink-900">${formatMoney(o.total_cents)}</td>
            <td class="px-4 py-2 text-xs text-ink-500">${formatFriendlyDateTime(o.occurred_at)}</td>
          `;
          tbody.appendChild(tr);
        }
      }
    }

    async function loadAll() {
      try {
        const storedName = window.localStorage.getItem('traqr_display_name');
        if (storedName) setUserName(storedName);
        let role = window.localStorage.getItem('traqr_role');
        try {
          const meRes = await fetch('/api/auth/me', { credentials: 'include' });
          if (meRes.ok) {
            const me = await meRes.json();
            if (me.display_name) {
              window.localStorage.setItem('traqr_display_name', me.display_name);
              setUserName(me.display_name);
            }
            if (me.role != null) {
              window.localStorage.setItem('traqr_role', me.role);
              role = me.role;
            }
          }
        } catch (_) {}
        const saRoles = ['sa_owner', 'sa_manager', 'sa_sales_rep'];
        const blogRoles = ['sa_owner', 'sa_manager'];
        if (role && saRoles.includes(role)) document.getElementById('sa-nav').classList.remove('hidden');
        if (role && blogRoles.includes(role)) {
          document.getElementById('blog-nav').classList.remove('hidden');
          var docsNew = document.getElementById('docs-new-nav');
          if (docsNew) docsNew.classList.remove('hidden');
        }
      } catch (_) {}
      await loadSummary();
      await loadRecentOrders();
      await loadCloudStatus();
    }

    function showToast(msg, type) {
      const el = document.getElementById('dashboard-toast');
      if (!el) return;
      el.textContent = msg;
      el.className = 'mx-4 mt-4 rounded-lg border px-4 py-3 text-sm sm:mx-6 lg:mx-8 ' +
        (type === 'success' ? 'border-emerald-200 bg-emerald-50 text-emerald-800' : 'border-red-200 bg-red-50 text-red-800');
      el.classList.remove('hidden');
      setTimeout(function () { el.classList.add('hidden'); }, 6000);
    }
    function closeDashboardNav() {
      document.getElementById('dashboard-sidebar').classList.remove('translate-x-0');
      document.getElementById('dashboard-sidebar').classList.add('-translate-x-full');
      document.getElementById('dashboard-sidebar-overlay').classList.add('hidden');
    }
    function openDashboardNav() {
      document.getElementById('dashboard-sidebar').classList.remove('-translate-x-full');
      document.getElementById('dashboard-sidebar').classList.add('translate-x-0');
      document.getElementById('dashboard-sidebar-overlay').classList.remove('hidden');
    }
    document.getElementById('refresh-btn').addEventListener('click', () => {
      loadAll().catch((err) => {
        console.error(err);
        showToast('Failed to refresh dashboard. Check network and API.', 'error');
      });
    });
    document.getElementById('dashboard-mobile-menu-btn').addEventListener('click', openDashboardNav);
    document.getElementById('dashboard-sidebar-overlay').addEventListener('click', closeDashboardNav);
    document.getElementById('dashboard-sidebar').querySelectorAll('a').forEach(function (a) {
      a.addEventListener('click', closeDashboardNav);
    });

    loadAll().catch((err) => {
      console.error(err);
    });
  </script>
</body>
</html>
