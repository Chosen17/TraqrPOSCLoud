<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Store — Traqr Cloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet" />
  <link href="/css/output.css" rel="stylesheet" />
</head>
<body class="min-h-screen bg-ink-100">
  <div class="flex min-h-screen">
    <!-- Sidebar: on mobile fixed and off-screen until opened -->
    <aside id="store-sidebar" class="fixed inset-y-0 left-0 z-40 flex w-64 shrink-0 flex-col border-r border-ink-200 bg-white px-4 py-6 transition-transform duration-200 -translate-x-full sm:relative sm:translate-x-0" aria-label="Main navigation">
      <a href="/" class="mb-8 inline-flex items-center gap-2 text-ink-900">
        <img src="/traqr.png" alt="Traqr" class="h-8 w-auto" />
        <span class="text-sm font-medium text-ink-600">Cloud</span>
      </a>
      <nav class="space-y-1 text-sm">
        <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Main</div>
        <a href="/dashboard" class="mt-1 block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Overview</a>
        <div class="mt-4 text-xs font-semibold uppercase tracking-wide text-ink-500">Operations</div>
        <a href="/organizations" class="mt-1 block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Organizations &amp; Stores</a>
        <a href="/ops-devices" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Devices &amp; Activation</a>
        <a href="/ops-menus" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Menus &amp; Availability</a>
        <a href="/ops-orders" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Orders &amp; Receipts</a>
        <a href="/ops-commands" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Command Center</a>
      </nav>
      <div class="mt-auto pt-6 text-xs text-ink-500">
        Logged in as <span id="user-name">Demo Admin</span>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 min-w-0">
      <!-- Top bar (mobile) -->
      <header class="flex items-center justify-between border-b border-ink-200 bg-white px-4 py-3 sm:hidden">
        <button type="button" id="store-mobile-menu-btn" class="rounded p-2 text-ink-600 hover:bg-ink-100" aria-label="Open menu">&#9776;</button>
        <a href="/" class="inline-flex items-center gap-2 text-ink-900">
          <img src="/traqr.png" alt="Traqr" class="h-7 w-auto" />
          <span class="text-sm font-medium text-ink-600">Cloud</span>
        </a>
        <span id="user-name-mobile" class="text-xs text-ink-500">Demo Admin</span>
      </header>
      <div id="store-sidebar-overlay" class="fixed inset-0 z-30 hidden bg-black/50 sm:hidden" aria-hidden="true"></div>

      <div id="store-toast" class="mx-4 mt-4 hidden rounded-lg border px-4 py-3 text-sm sm:mx-6 lg:mx-8" role="alert"></div>

      <div class="mx-auto max-w-6xl px-4 py-6 sm:px-6 lg:px-8">
        <!-- Store header -->
        <header>
          <p id="store-breadcrumb" class="text-xs text-ink-500">
            <a href="/organizations" class="hover:text-ink-800">Organizations</a>
            <span>/</span>
            <span id="store-org-name">Org</span>
          </p>
          <div class="mt-1 flex items-center justify-between gap-4">
            <div>
              <h1 id="store-name" class="font-display text-2xl font-bold text-ink-900">Store</h1>
              <p id="store-subtitle" class="mt-1 text-xs text-ink-600">Cloud status and last POS activity.</p>
            </div>
            <div class="flex flex-col items-end gap-1 text-right text-xs">
              <span id="store-cloud-status" class="inline-flex items-center rounded-full bg-ink-50 px-2 py-0.5 font-medium text-ink-600">Cloud Sync: Unknown</span>
              <span id="store-last-event" class="text-ink-500">Last event: –</span>
            </div>
          </div>
        </header>

        <!-- Tabs -->
        <div class="mt-6 border-b border-ink-200 text-sm overflow-x-auto">
          <nav class="-mb-px flex flex-nowrap gap-2 sm:flex-wrap sm:gap-4 min-w-0" aria-label="Store sections">
            <button data-tab="devices" class="store-tab border-b-2 border-ink-900 pb-2 font-medium text-ink-900">Devices</button>
            <button data-tab="menu" class="store-tab border-b-2 border-transparent pb-2 font-medium text-ink-600 hover:text-ink-900">Menu</button>
            <button data-tab="orders" class="store-tab border-b-2 border-transparent pb-2 font-medium text-ink-600 hover:text-ink-900">Orders</button>
            <button data-tab="commands" class="store-tab border-b-2 border-transparent pb-2 font-medium text-ink-600 hover:text-ink-900">Command Center</button>
            <button data-tab="delivery" class="store-tab border-b-2 border-transparent pb-2 font-medium text-ink-600 hover:text-ink-900">Delivery Integrations</button>
          </nav>
        </div>

        <!-- Tab panels -->
        <section id="tab-devices" class="mt-6">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm font-semibold text-ink-900">Devices &amp; activation codes</h2>
            <button id="refresh-devices-btn" class="btn-secondary text-xs">Refresh</button>
          </div>
          <div class="mt-3 grid gap-4 lg:grid-cols-3">
            <div class="card lg:col-span-2">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-ink-500">Devices</h3>
              <div class="mt-3 overflow-hidden rounded-xl border border-ink-100">
                <table class="min-w-full divide-y divide-ink-100 text-xs">
                  <thead class="bg-ink-50 text-ink-500">
                    <tr>
                      <th class="px-3 py-1 text-left font-medium">Name</th>
                      <th class="px-3 py-1 text-left font-medium">Role</th>
                      <th class="px-3 py-1 text-left font-medium">Status</th>
                      <th class="px-3 py-1 text-left font-medium">Last seen</th>
                    </tr>
                  </thead>
                  <tbody id="store-devices-body" class="divide-y divide-ink-100 bg-white"></tbody>
                </table>
                <p id="store-devices-empty" class="px-3 py-4 text-center text-xs text-ink-500">
                  No devices yet. Create an activation code below, then enter it on the till (Settings → Cloud).
                </p>
              </div>
            </div>

            <div class="card">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-ink-500">Activation codes</h3>
              <p class="mt-1 text-xs text-ink-600">Codes for this store. Create one, then type or paste it into the till.</p>
              <button id="issue-key-btn" class="mt-2 btn-secondary w-full text-xs">Create new activation code</button>
              <div id="store-new-key-result" class="mt-3 hidden rounded-lg border border-emerald-200 bg-emerald-50 p-3 text-sm">
                <p class="font-medium text-emerald-900">New activation code</p>
                <p class="mt-1 text-xs text-emerald-800">Copy this and enter it on the till (Settings → Cloud). You won’t see it again.</p>
                <div class="mt-2 flex flex-wrap items-center gap-2">
                  <code id="store-new-key-value" class="rounded bg-white px-2 py-1 font-mono text-ink-900"></code>
                  <button type="button" id="store-copy-key-btn" class="btn-secondary text-xs">Copy code</button>
                </div>
              </div>
              <div class="mt-3 max-h-64 space-y-2 overflow-y-auto text-xs" id="store-keys-list"></div>
              <p id="store-keys-empty" class="mt-2 text-xs text-ink-500">
                No codes yet. Click &quot;Create new activation code&quot; above. Give the code to staff to enter on the till.
              </p>
            </div>
          </div>
        </section>

        <section id="tab-menu" class="mt-6 hidden">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm font-semibold text-ink-900">Menu &amp; availability</h2>
            <button id="refresh-menu-btn" class="btn-secondary text-xs">Refresh</button>
          </div>
          <div class="mt-4 grid gap-4 lg:grid-cols-[240px,minmax(0,1fr)]">
            <aside class="card">
              <div class="flex items-center justify-between gap-2">
                <h3 class="text-xs font-semibold uppercase tracking-wide text-ink-500">Categories</h3>
                <button type="button" id="add-category-btn" class="text-xs font-medium text-traqr-600 hover:text-traqr-500">+ Add</button>
              </div>
              <ul id="menu-categories" class="mt-3 space-y-1 text-sm"></ul>
              <p id="menu-categories-empty" class="mt-3 text-xs text-ink-500">
                No categories yet. Add one here or sync from your POS.
              </p>
              <div id="add-category-form" class="mt-3 hidden rounded-lg border border-ink-200 bg-ink-50/60 p-3">
                <label class="block text-xs font-medium text-ink-700">Name</label>
                <input type="text" id="new-category-name" class="mt-1 w-full rounded border border-ink-200 px-2 py-1.5 text-sm" placeholder="e.g. Mains" maxlength="255" />
                <label class="mt-2 block text-xs font-medium text-ink-700">Position</label>
                <input type="number" id="new-category-position" class="mt-1 w-full rounded border border-ink-200 px-2 py-1.5 text-sm" value="0" min="0" />
                <div class="mt-2 flex gap-2">
                  <button type="button" id="add-category-submit" class="btn-primary text-xs">Create</button>
                  <button type="button" id="add-category-cancel" class="btn-secondary text-xs">Cancel</button>
                </div>
              </div>
            </aside>
            <div class="card">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <h3 id="menu-category-name" class="text-sm font-semibold text-ink-900">Items</h3>
                  <p id="menu-category-meta" class="mt-0.5 text-xs text-ink-500">Select a category to view items.</p>
                </div>
                <button type="button" id="add-item-btn" class="text-xs font-medium text-traqr-600 hover:text-traqr-500">+ Add item</button>
              </div>
              <input type="file" id="menu-item-image-input" accept="image/jpeg,image/png,image/gif,image/webp" class="hidden" />
              <div id="menu-items-list" class="mt-3 divide-y divide-ink-100"></div>
              <p id="menu-items-empty" class="mt-3 text-xs text-ink-500">No items for this category.</p>
              <div id="add-item-form" class="mt-3 hidden rounded-lg border border-ink-200 bg-ink-50/60 p-3">
                <label class="block text-xs font-medium text-ink-700">Name</label>
                <input type="text" id="new-item-name" class="mt-1 w-full rounded border border-ink-200 px-2 py-1.5 text-sm" placeholder="e.g. Fish &amp; chips" maxlength="255" />
                <label class="mt-2 block text-xs font-medium text-ink-700">Description (optional)</label>
                <input type="text" id="new-item-description" class="mt-1 w-full rounded border border-ink-200 px-2 py-1.5 text-sm" placeholder="Optional" maxlength="500" />
                <label class="mt-2 block text-xs font-medium text-ink-700">Price (£)</label>
                <input type="number" id="new-item-price" class="mt-1 w-full rounded border border-ink-200 px-2 py-1.5 text-sm" placeholder="0.00" min="0" step="0.01" />
                <label class="mt-2 block text-xs font-medium text-ink-700">Category</label>
                <select id="new-item-category" class="mt-1 w-full rounded border border-ink-200 px-2 py-1.5 text-sm">
                  <option value="">— None —</option>
                </select>
                <div class="mt-2 flex items-center gap-4">
                  <label class="flex items-center gap-1.5 text-xs text-ink-700">
                    <input type="checkbox" id="new-item-active" checked />
                    Active (visible on menu)
                  </label>
                  <label class="flex items-center gap-1.5 text-xs text-ink-700">
                    <input type="checkbox" id="new-item-customer-editable" />
                    Customer editable
                  </label>
                </div>
                <div class="mt-2 flex gap-2">
                  <button type="button" id="add-item-submit" class="btn-primary text-xs">Create</button>
                  <button type="button" id="add-item-cancel" class="btn-secondary text-xs">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="tab-orders" class="mt-6 hidden">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm font-semibold text-ink-900">Orders</h2>
            <button id="refresh-orders-btn" class="btn-secondary text-xs">Refresh</button>
          </div>
          <div class="mt-3 overflow-hidden rounded-xl border border-ink-200 bg-white">
            <table class="min-w-full divide-y divide-ink-100 text-xs">
              <thead class="bg-ink-50 text-ink-500">
                <tr>
                  <th class="px-3 py-1 text-left font-medium">Order</th>
                  <th class="px-3 py-1 text-left font-medium">Status</th>
                  <th class="px-3 py-1 text-right font-medium">Total</th>
                  <th class="px-3 py-1 text-left font-medium">Occurred at</th>
                  <th class="px-3 py-1 text-right font-medium"></th>
                </tr>
              </thead>
              <tbody id="store-orders-body" class="divide-y divide-ink-100 bg-white"></tbody>
            </table>
            <p id="store-orders-empty" class="px-3 py-4 text-center text-xs text-ink-500">
              No orders yet. When POS devices sync, orders will appear here.
            </p>
          </div>
        </section>

        <section id="tab-commands" class="mt-6 hidden">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm font-semibold text-ink-900">Command Center</h2>
            <button id="refresh-commands-btn" class="btn-secondary text-xs">Refresh</button>
          </div>
          <p class="mt-2 text-xs text-ink-600">
            Enqueue void and refund commands for orders. This is a read-only view for now; enqueuing can be added on the order detail page.
          </p>
          <div class="mt-3 overflow-hidden rounded-xl border border-ink-200 bg-white">
            <table class="min-w-full divide-y divide-ink-100 text-xs">
              <thead class="bg-ink-50 text-ink-500">
                <tr>
                  <th class="px-3 py-1 text-left font-medium">Command</th>
                  <th class="px-3 py-1 text-left font-medium">Order</th>
                  <th class="px-3 py-1 text-left font-medium">Status</th>
                  <th class="px-3 py-1 text-left font-medium">Device</th>
                  <th class="px-3 py-1 text-left font-medium">Created</th>
                </tr>
              </thead>
              <tbody id="store-commands-body" class="divide-y divide-ink-100 bg-white"></tbody>
            </table>
            <p id="store-commands-empty" class="px-3 py-4 text-center text-xs text-ink-500">
              No commands queued yet. They will appear here when created from the portal.
            </p>
          </div>
        </section>

        <section id="tab-delivery" class="mt-6 hidden">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm font-semibold text-ink-900">Delivery Integrations</h2>
            <button id="refresh-delivery-btn" class="btn-secondary text-xs">Refresh</button>
          </div>
          <p class="mt-2 text-xs text-ink-600">
            Connect Just Eat, Deliveroo, and Uber Eats for this store. Paste API keys or credentials, Traqr Cloud takes care of the rest.
          </p>
          <div id="delivery-integrations" class="mt-3 grid gap-4 md:grid-cols-3">
            <!-- Cards populated via JS -->
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function setUserName(name) {
      const n = name || 'Demo Admin';
      document.getElementById('user-name').textContent = n;
      document.getElementById('user-name-mobile').textContent = n;
    }

    function showToast(message, type) {
      const el = document.getElementById('store-toast');
      if (!el) return;
      el.textContent = message;
      el.className = 'mx-4 mt-4 rounded-lg border px-4 py-3 text-sm sm:mx-6 lg:mx-8 ' +
        (type === 'success' ? 'border-emerald-200 bg-emerald-50 text-emerald-800' : 'border-red-200 bg-red-50 text-red-800');
      el.classList.remove('hidden');
      el.setAttribute('role', 'alert');
      setTimeout(function () { el.classList.add('hidden'); }, 6000);
    }

    function closeMobileNav() {
      const sidebar = document.getElementById('store-sidebar');
      const overlay = document.getElementById('store-sidebar-overlay');
      if (sidebar) { sidebar.classList.remove('translate-x-0'); sidebar.classList.add('-translate-x-full'); }
      if (overlay) overlay.classList.add('hidden');
    }
    function openMobileNav() {
      const sidebar = document.getElementById('store-sidebar');
      const overlay = document.getElementById('store-sidebar-overlay');
      if (sidebar) { sidebar.classList.remove('-translate-x-full'); sidebar.classList.add('translate-x-0'); }
      if (overlay) overlay.classList.remove('hidden');
    }

    function formatDateTime(value) {
      if (!value) return '–';
      return value.replace('T', ' ');
    }
    function formatFriendlyDateTime(value) {
      if (!value) return '–';
      const d = new Date(value);
      if (isNaN(d.getTime())) return value;
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const day = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const time = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true });
      const dateStr = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: d.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
      if (day.getTime() === today.getTime()) return 'Today ' + time;
      if (day.getTime() === yesterday.getTime()) return 'Yesterday ' + time;
      return dateStr + ', ' + time;
    }

    function formatMoney(cents) {
      if (cents == null) return '–';
      const value = (cents / 100).toFixed(2);
      return '£' + value;
    }

    function switchTab(tabId) {
      document.querySelectorAll('.store-tab').forEach((btn) => {
        const active = btn.dataset.tab === tabId;
        btn.className = 'store-tab border-b-2 pb-2 font-medium ' + (active ? 'border-ink-900 text-ink-900' : 'border-transparent text-ink-600 hover:text-ink-900');
      });
      ['devices', 'menu', 'orders', 'commands', 'delivery'].forEach((id) => {
        const panel = document.getElementById('tab-' + id);
        if (!panel) return;
        panel.classList.toggle('hidden', id !== tabId);
      });
    }

    function shortId(uuid) {
      if (!uuid || typeof uuid !== 'string') return '—';
      return uuid.replace(/-/g, '').slice(0, 8);
    }
    async function loadStoreHeader(storeId) {
      const res = await fetch(`/api/portal/stores/${encodeURIComponent(storeId)}/meta`);
      if (!res.ok) {
        document.getElementById('store-name').textContent = 'Store ' + shortId(storeId);
        document.getElementById('store-subtitle').textContent = 'Store ' + shortId(storeId);
        return;
      }
      const data = await res.json();
      window.currentStoreMeta = data;
      document.getElementById('store-name').textContent = data.name;
      document.getElementById('store-subtitle').innerHTML = `Store <code class="rounded bg-ink-100 px-1 text-[11px]" title="${(data.id || '').replace(/"/g, '&quot;')}">${shortId(data.id)}</code>`;
    }

    async function loadDevices(storeId) {
      const res = await fetch(`/api/portal/stores/${encodeURIComponent(storeId)}/devices`);
      if (!res.ok) throw new Error('Failed to load devices');
      const data = await res.json();
      const body = document.getElementById('store-devices-body');
      const empty = document.getElementById('store-devices-empty');
      body.innerHTML = '';
      const devices = data.devices || [];
      if (devices.length === 0) {
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        for (const d of devices) {
          const name = d.device_name || d.device_label || ('Device ' + (d.id || '').slice(0, 8));
          const primaryBadge = d.is_primary ? '<span class="inline-flex rounded-full bg-traqr-50 px-2 py-0.5 text-[11px] font-medium text-traqr-700">Primary</span>' : '<span class="text-ink-400 text-[11px]">—</span>';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-3 py-2 align-top text-ink-800">${name}</td>
            <td class="px-3 py-2 align-top text-xs">${primaryBadge}</td>
            <td class="px-3 py-2 align-top text-xs">
              <span class="inline-flex rounded-full px-2 py-0.5 text-[11px] font-medium ${
                d.status === 'active'
                  ? 'bg-emerald-50 text-emerald-700'
                  : 'bg-ink-50 text-ink-600'
              }">${d.status}</span>
            </td>
            <td class="px-3 py-2 align-top text-xs text-ink-500">${formatFriendlyDateTime(d.last_seen_at)}</td>
          `;
          body.appendChild(tr);
        }
      }
    }

    async function loadActivationKeys(storeId) {
      const res = await fetch(`/api/portal/stores/${encodeURIComponent(storeId)}/activation-keys`);
      if (!res.ok) throw new Error('Failed to load activation keys');
      const data = await res.json();
      const list = document.getElementById('store-keys-list');
      const empty = document.getElementById('store-keys-empty');
      list.innerHTML = '';
      const keys = data.keys || [];
      if (keys.length === 0) {
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        for (const k of keys) {
          const div = document.createElement('div');
          const statusLabel = k.revoked_at
            ? 'Revoked'
            : k.expires_at && new Date(k.expires_at) < new Date()
              ? 'Expired'
              : 'Active';
          const statusClass = k.revoked_at
            ? 'bg-rose-50 text-rose-700'
            : k.expires_at && new Date(k.expires_at) < new Date()
              ? 'bg-amber-50 text-amber-700'
              : 'bg-emerald-50 text-emerald-700';
          div.className = 'rounded-lg border border-ink-100 bg-ink-50/60 p-2';
          div.innerHTML = `
            <div class="flex items-center justify-between gap-2">
              <div class="text-[11px] text-ink-700">
                <div class="font-medium">${k.scope_type} scope</div>
                <div class="text-ink-500">Uses: ${k.uses_count}${k.max_uses ? ' / ' + k.max_uses : ''}</div>
              </div>
              <span class="inline-flex rounded-full px-2 py-0.5 text-[10px] font-medium ${statusClass}">${statusLabel}</span>
            </div>
            <div class="mt-1 text-[10px] text-ink-500">
              Expires: ${k.expires_at ? formatFriendlyDateTime(k.expires_at) : 'No expiry'}
            </div>
          `;
          list.appendChild(div);
        }
      }
    }

    async function loadMenu(storeId, categoryId) {
      const url = new URL(window.location.origin + `/api/portal/stores/${encodeURIComponent(storeId)}/menu`);
      if (categoryId) {
        url.searchParams.set('category_id', categoryId);
      }
      url.searchParams.set('_', String(Date.now()));
      const res = await fetch(url.toString().replace(window.location.origin, ''), { credentials: 'include', cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load menu');
      const data = await res.json();
      const categories = data.categories || [];
      window.menuCategories = categories;
      const items = data.items || [];

      const catList = document.getElementById('menu-categories');
      const catEmpty = document.getElementById('menu-categories-empty');
      catList.innerHTML = '';
      if (categories.length === 0) {
        catEmpty.classList.remove('hidden');
      } else {
        catEmpty.classList.add('hidden');
        for (const c of categories) {
          const li = document.createElement('li');
          li.innerHTML = `
            <button type="button" class="flex w-full items-center justify-between rounded-lg px-3 py-1.5 text-left text-sm hover:bg-ink-50" data-category-id="${c.id}">
              <span>${c.name}</span>
            </button>
          `;
          const btn = li.querySelector('button');
          btn.addEventListener('click', () => {
            loadMenu(storeId, c.id).catch(err => {
              console.error(err);
              showToast('Failed to load category.', 'error');
            });
          });
          catList.appendChild(li);
        }
      }

      const itemsList = document.getElementById('menu-items-list');
      const itemsEmpty = document.getElementById('menu-items-empty');
      const catName = document.getElementById('menu-category-name');
      const catMeta = document.getElementById('menu-category-meta');

      if (categories.length > 0) {
        const selected = categories.find(c => c.id === (categoryId || (categories[0] && categories[0].id))) || categories[0];
        catName.textContent = selected ? selected.name : 'Items';
        catMeta.textContent = selected ? `Category • ${selected.position}` : 'Select a category to view items.';
      } else if (items.length > 0) {
        catName.textContent = 'All items';
        catMeta.textContent = 'Items synced from POS (no categories yet).';
      } else {
        catName.textContent = 'Items';
        catMeta.textContent = 'Select a category to view items.';
      }

      itemsList.innerHTML = '';
      if (items.length === 0) {
        itemsEmpty.classList.remove('hidden');
      } else {
        itemsEmpty.classList.add('hidden');
        for (const it of items) {
          const badge = it.active
            ? '<span class="inline-flex rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-medium text-emerald-700">Active</span>'
            : '<span class="inline-flex rounded-full bg-ink-50 px-2 py-0.5 text-[11px] font-medium text-ink-600">Hidden</span>';
          const modifiers = it.has_modifiers
            ? '<span class="ml-2 inline-flex rounded-full bg-ink-50 px-2 py-0.5 text-[10px] font-medium text-ink-600">Modifiers</span>'
            : '';
          const yieldInfo =
            it.remaining != null || it.estimated_total != null
              ? `<div class="mt-1 text-[11px] text-ink-500">Yield: ${it.remaining != null ? it.remaining : '–'} / ${it.estimated_total != null ? it.estimated_total : '–'}${it.warning_threshold != null ? ' (warn at ' + it.warning_threshold + ')' : ''}</div>`
              : '';
          const imgSrc = (function () {
            const p = it.image_path;
            if (!p || typeof p !== 'string') return '';
            if (/^https?:\/\//i.test(p)) return p;
            const rel = String(p).replace(/^\//, '').trim();
            return rel.startsWith('uploads/') ? '/' + rel : '/uploads/' + rel;
          })();
          const imgOrPlaceholder = imgSrc
            ? `<img src="${imgSrc.replace(/"/g, '&quot;')}" alt="" class="h-10 w-10 rounded-lg object-cover ring-1 ring-ink-200" onerror="this.style.display='none'" />`
            : '<button type="button" class="menu-item-add-image h-10 w-10 rounded-lg border border-dashed border-ink-300 bg-ink-50 text-[10px] text-ink-500 hover:border-traqr-400 hover:bg-traqr-50 hover:text-traqr-700" data-store-id="' + (storeId || '').replace(/"/g, '&quot;') + '" data-item-id="' + (it.id || '').replace(/"/g, '&quot;') + '" title="Add image">+ Image</button>';
          const row = document.createElement('div');
          row.className = 'flex items-start gap-3 px-3 py-2';
          row.innerHTML = `
            <div class="h-10 w-10 shrink-0 flex items-center justify-center overflow-hidden rounded-lg bg-ink-50">${imgOrPlaceholder}</div>
            <div class="flex-1">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="text-sm font-medium text-ink-900">${it.name}</div>
                  <div class="mt-0.5 text-xs text-ink-600">${it.description || ''}</div>
                  ${yieldInfo}
                </div>
                <div class="text-right text-xs text-ink-800">
                  <div class="font-semibold">${formatMoney(it.price_pence)}</div>
                  <div class="mt-1">${badge}${modifiers}</div>
                </div>
              </div>
            </div>
          `;
          itemsList.appendChild(row);
        }
      }
    }

    async function loadOrders(storeId) {
      const res = await fetch(`/api/portal/stores/${encodeURIComponent(storeId)}/orders`);
      if (!res.ok) throw new Error('Failed to load orders');
      const data = await res.json();
      const orders = data.orders || [];
      const body = document.getElementById('store-orders-body');
      const empty = document.getElementById('store-orders-empty');
      body.innerHTML = '';
      if (orders.length === 0) {
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        for (const o of orders) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-3 py-2 align-top font-mono text-[11px] text-ink-700">${o.local_order_id}</td>
            <td class="px-3 py-2 align-top text-xs">
              <span class="inline-flex rounded-full px-2 py-0.5 text-[11px] font-medium ${
                o.status === 'open'
                  ? 'bg-amber-50 text-amber-800'
                  : 'bg-emerald-50 text-emerald-800'
              }">${o.status}</span>
            </td>
            <td class="px-3 py-2 align-top text-right text-ink-900">${formatMoney(o.total_cents)}</td>
            <td class="px-3 py-2 align-top text-xs text-ink-500">${formatFriendlyDateTime(o.occurred_at)}</td>
            <td class="px-3 py-2 align-top text-right">
              <a href="/order?order_id=${encodeURIComponent(o.id)}" class="text-[11px] font-medium text-traqr-600 hover:text-traqr-500">View</a>
            </td>
          `;
          body.appendChild(tr);
        }
      }
    }

    async function loadCommands(storeId) {
      const res = await fetch(`/api/portal/stores/${encodeURIComponent(storeId)}/commands`);
      if (!res.ok) throw new Error('Failed to load commands');
      const data = await res.json();
      const commands = data.commands || [];
      const body = document.getElementById('store-commands-body');
      const empty = document.getElementById('store-commands-empty');
      body.innerHTML = '';
      if (commands.length === 0) {
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        for (const c of commands) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-3 py-2 align-top text-xs text-ink-800">${c.command_type}${c.sensitive ? ' · sensitive' : ''}</td>
            <td class="px-3 py-2 align-top font-mono text-[11px] text-ink-700">${c.local_order_id || '—'}</td>
            <td class="px-3 py-2 align-top text-xs text-ink-700">${c.status}</td>
            <td class="px-3 py-2 align-top font-mono text-[11px] text-ink-500">${c.device_id}</td>
            <td class="px-3 py-2 align-top text-xs text-ink-500">${formatFriendlyDateTime(c.created_at)}</td>
          `;
          body.appendChild(tr);
        }
      }
    }

    function renderDeliveryCard(container, provider, data, storeId) {
      const status = data?.status || 'disconnected';
      const lastSync = data?.last_sync_at || null;
      const statusLabel =
        status === 'connected'
          ? 'Connected'
          : status === 'pending'
          ? 'Pending'
          : status === 'error'
          ? 'Error'
          : 'Disconnected';
      const statusClass =
        status === 'connected'
          ? 'bg-emerald-50 text-emerald-700'
          : status === 'error'
          ? 'bg-rose-50 text-rose-700'
          : status === 'pending'
          ? 'bg-amber-50 text-amber-800'
          : 'bg-ink-50 text-ink-600';
      const title =
        provider === 'just_eat'
          ? 'Just Eat'
          : provider === 'deliveroo'
          ? 'Deliveroo'
          : 'Uber Eats';
      const isComingSoon = provider === 'just_eat';
      const connectLabel = isComingSoon
        ? 'Coming soon'
        : status === 'connected'
        ? 'Disconnect'
        : 'Connect';
      const connectAction = isComingSoon
        ? 'coming-soon'
        : status === 'connected'
        ? 'disconnect'
        : 'connect';

      const card = document.createElement('div');
      card.className = 'rounded-xl border border-ink-100 bg-white p-3 shadow-sm flex flex-col justify-between';
      card.innerHTML = `
        <div>
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="text-sm font-semibold text-ink-900">${title}</div>
              <div class="mt-0.5 text-xs text-ink-500">Per-store integration • ${storeId.slice(0, 8)}</div>
            </div>
            <span class="inline-flex rounded-full px-2 py-0.5 text-[11px] font-medium ${statusClass}">${statusLabel}</span>
          </div>
          <div class="mt-2 text-[11px] text-ink-500">
            Last sync: ${lastSync ? formatFriendlyDateTime(lastSync) : '—'}
          </div>
          ${data?.last_error_message ? `<div class="mt-1 text-[11px] text-rose-600">Error: ${data.last_error_message}</div>` : ''}
        </div>
        <div class="mt-3 flex flex-wrap items-center gap-2 text-[11px]">
          <button type="button" class="btn-secondary px-3 py-1 text-[11px]" data-provider="${provider}" data-action="${connectAction}" ${isComingSoon ? 'disabled' : ''}>
            ${connectLabel}
          </button>
          <button type="button" class="px-2 py-1 text-traqr-600 hover:text-traqr-500" data-provider="${provider}" data-action="test" ${isComingSoon ? 'disabled' : ''}>
            Test connection
          </button>
          <button type="button" class="px-2 py-1 text-ink-500 hover:text-ink-800" data-provider="${provider}" data-action="logs">
            View logs
          </button>
        </div>
      `;
      container.appendChild(card);
    }

    async function loadDeliveryIntegrations(storeId) {
      const res = await fetch(`/api/portal/stores/${encodeURIComponent(storeId)}/delivery_integrations`);
      if (!res.ok) throw new Error('Failed to load delivery integrations');
      const data = await res.json();
      const container = document.getElementById('delivery-integrations');
      container.innerHTML = '';
      const map = data.integrations || {};
      const providers = ['just_eat', 'deliveroo', 'uber_eats'];
      for (const p of providers) {
        renderDeliveryCard(container, p, map[p] || null, storeId);
      }

      container.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-provider][data-action]');
        if (!btn) return;
        const provider = btn.getAttribute('data-provider');
        const action = btn.getAttribute('data-action');
        if (action === 'coming-soon') {
          showToast('Just Eat integration is coming soon. Deliveroo and Uber Eats are available to connect today.', 'error');
          return;
        }
        if (action === 'logs') {
          window.location.href = `/ops-commands?view=delivery&store_id=${encodeURIComponent(storeId)}&provider=${encodeURIComponent(provider)}`;
          return;
        }
        if (action === 'test') {
          try {
            const r = await fetch(`/api/portal/stores/${encodeURIComponent(storeId)}/delivery_integrations/${encodeURIComponent(provider)}/test`, { method: 'POST' });
            const body = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(body.message || 'Test failed');
            alert(body.message || 'Connection OK');
          } catch (err) {
            console.error(err);
            showToast('Test failed: ' + (err && err.message ? err.message : 'Unknown error'), 'error');
          }
          return;
        }
        if (action === 'connect') {
          let payload = null;
          if (provider === 'uber_eats') {
            const clientId = prompt('Enter Uber Eats Client ID (from Uber Developer Dashboard) for this store.');
            if (!clientId) return;
            const clientSecret = prompt('Enter Uber Eats Client Secret (will be stored encrypted).');
            if (!clientSecret) return;
            const storeRef = prompt('Enter the Uber Eats store/location id (meta.user_id in webhooks).');
            if (!storeRef) return;
            payload = {
              api_key: clientId, // stored but not used for Uber; client_id/client_secret drive OAuth
              provider_store_reference: storeRef,
              client_id: clientId,
              client_secret: clientSecret,
            };
          } else if (provider === 'deliveroo') {
            const webhookSecret = prompt('Enter Deliveroo webhook secret (from Deliveroo Developer Portal) for this store.');
            if (!webhookSecret) return;
            const storeRef = prompt('Enter the Deliveroo location_id for this store (used in webhooks).');
            if (!storeRef) return;
            payload = {
              api_key: webhookSecret, // used as HMAC secret for Deliveroo webhooks
              provider_store_reference: storeRef,
            };
          } else {
            const apiKey = prompt('Enter Just Eat JE-API-KEY (from Just Eat partner portal) for this store.');
            if (!apiKey) return;
            const storeRef = prompt('Enter the Just Eat restaurant/store identifier (e.g. restaurant_id).');
            if (!storeRef) return;
            payload = {
              api_key: apiKey,
              provider_store_reference: storeRef,
            };
          }
          try {
            const r = await fetch(`/api/portal/stores/${encodeURIComponent(storeId)}/delivery_integrations/${encodeURIComponent(provider)}/connect`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const body = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(body.message || 'Connect failed');
            showToast(body.message || 'Connected successfully', 'success');
            await loadDeliveryIntegrations(storeId);
          } catch (err) {
            console.error(err);
            showToast('Connect failed: ' + (err && err.message ? err.message : 'Unknown error'), 'error');
          }
          return;
        }
        if (action === 'disconnect') {
          if (!confirm('Disconnect this provider for this store? Orders will stop syncing.')) return;
          try {
            const r = await fetch(`/api/portal/stores/${encodeURIComponent(storeId)}/delivery_integrations/${encodeURIComponent(provider)}/disconnect`, {
              method: 'POST'
            });
            const body = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(body.message || 'Disconnect failed');
            showToast(body.message || 'Disconnected.', 'success');
            await loadDeliveryIntegrations(storeId);
          } catch (err) {
            console.error(err);
            showToast('Disconnect failed: ' + (err && err.message ? err.message : 'Unknown error'), 'error');
          }
        }
      }, { once: true });
    }

    async function init() {
      const storeId = getQueryParam('store_id');
      if (!storeId) {
        document.getElementById('store-toast').textContent = 'Missing store_id in URL. Open a store from Organizations.';
        document.getElementById('store-toast').className = 'mx-4 mt-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800 sm:mx-6 lg:mx-8';
        document.getElementById('store-toast').classList.remove('hidden');
        return;
      }
      try {
        const storedName = window.localStorage.getItem('traqr_display_name');
        if (storedName) setUserName(storedName);
      } catch (_) {}

      document.querySelectorAll('.store-tab').forEach((btn) => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          switchTab(tab);
          if (tab === 'menu') {
            loadMenu(storeId).catch(err => {
              console.error(err);
              showToast('Failed to load menu.', 'error');
            });
          } else if (tab === 'orders') {
            loadOrders(storeId).catch(err => {
              console.error(err);
              showToast('Failed to load orders.', 'error');
            });
          } else if (tab === 'commands') {
            loadCommands(storeId).catch(err => {
              console.error(err);
              showToast('Failed to load commands.', 'error');
            });
          } else if (tab === 'delivery') {
            loadDeliveryIntegrations(storeId).catch(err => {
              console.error(err);
              showToast('Failed to load delivery integrations.', 'error');
            });
          }
        });
      });
      document.getElementById('refresh-devices-btn').addEventListener('click', () => {
        loadDevices(storeId).catch(err => {
          console.error(err);
          showToast('Failed to refresh devices.', 'error');
        });
        loadActivationKeys(storeId).catch(err => {
          console.error(err);
          showToast('Failed to refresh activation keys.', 'error');
        });
      });
      document.getElementById('issue-key-btn').addEventListener('click', async () => {
        if (!window.currentStoreMeta) {
          showToast('Store metadata not loaded yet. Wait a moment and try again.', 'error');
          return;
        }
        if (!confirm('Create a new activation code for this store? You’ll see it once — copy it and enter it on the till.')) {
          return;
        }
        const resultEl = document.getElementById('store-new-key-result');
        const keyEl = document.getElementById('store-new-key-value');
        try {
          const res = await fetch('/api/admin/activation-keys', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              org_id: window.currentStoreMeta.org_id,
              store_id: window.currentStoreMeta.id,
              scope_type: 'store',
              scope_id: window.currentStoreMeta.id,
              max_uses: 5
            })
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || 'Failed to issue activation key');
          }
          const data = await res.json();
          const key = data.activation_key;
          if (keyEl) keyEl.textContent = key;
          if (resultEl) { resultEl.classList.remove('hidden'); }
          await loadActivationKeys(storeId);
        } catch (err) {
          console.error(err);
          showToast('Could not create activation code. Try again or check with your admin.', 'error');
        }
      });
      document.getElementById('refresh-menu-btn').addEventListener('click', () => {
        loadMenu(storeId).catch(err => {
          console.error(err);
          showToast('Failed to refresh menu.', 'error');
        });
      });
      const addCategoryForm = document.getElementById('add-category-form');
      const addItemForm = document.getElementById('add-item-form');
      document.getElementById('add-category-btn').addEventListener('click', () => {
        addCategoryForm.classList.remove('hidden');
        document.getElementById('new-category-name').value = '';
        document.getElementById('new-category-position').value = '0';
        document.getElementById('new-category-name').focus();
      });
      document.getElementById('add-category-cancel').addEventListener('click', () => {
        addCategoryForm.classList.add('hidden');
      });
      document.getElementById('add-category-submit').addEventListener('click', async () => {
        const name = document.getElementById('new-category-name').value.trim();
        if (!name) {
          showToast('Enter a category name.', 'error');
          return;
        }
        const position = parseInt(document.getElementById('new-category-position').value, 10) || 0;
        try {
          const r = await fetch('/api/portal/stores/' + encodeURIComponent(storeId) + '/menu/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name, position })
          });
          if (!r.ok) {
            const t = await r.text();
            throw new Error(t || 'Failed to create category');
          }
          addCategoryForm.classList.add('hidden');
          await loadMenu(storeId);
        } catch (err) {
          console.error(err);
          showToast(err && err.message ? err.message : 'Failed to create category.', 'error');
        }
      });
      document.getElementById('add-item-btn').addEventListener('click', () => {
        const sel = document.getElementById('new-item-category');
        sel.innerHTML = '<option value="">— None —</option>';
        (window.menuCategories || []).forEach((c) => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name;
          sel.appendChild(opt);
        });
        addItemForm.classList.remove('hidden');
        document.getElementById('new-item-name').value = '';
        document.getElementById('new-item-description').value = '';
        document.getElementById('new-item-price').value = '';
        document.getElementById('new-item-active').checked = true;
        document.getElementById('new-item-customer-editable').checked = false;
        document.getElementById('new-item-name').focus();
      });
      document.getElementById('add-item-cancel').addEventListener('click', () => {
        addItemForm.classList.add('hidden');
      });
      document.getElementById('add-item-submit').addEventListener('click', async () => {
        const name = document.getElementById('new-item-name').value.trim();
        if (!name) {
          showToast('Enter an item name.', 'error');
          return;
        }
        const description = document.getElementById('new-item-description').value.trim() || null;
        const priceStr = document.getElementById('new-item-price').value.trim();
        const pricePence = priceStr === '' ? null : Math.round(parseFloat(priceStr) * 100);
        const categoryId = document.getElementById('new-item-category').value.trim() || null;
        const active = document.getElementById('new-item-active').checked;
        const customerEditable = document.getElementById('new-item-customer-editable').checked;
        const body = { name, description, price_pence: pricePence, active, customer_editable: customerEditable };
        if (categoryId) body.category_id = categoryId;
        try {
          const r = await fetch('/api/portal/stores/' + encodeURIComponent(storeId) + '/menu/items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(body)
          });
          if (!r.ok) {
            const data = await r.json().catch(() => ({}));
            throw new Error(data.message || (await r.text()) || 'Failed to create item');
          }
          addItemForm.classList.add('hidden');
          await loadMenu(storeId);
        } catch (err) {
          console.error(err);
          showToast(err && err.message ? err.message : 'Failed to create item.', 'error');
        }
      });
      document.getElementById('menu-items-list').addEventListener('click', function (e) {
        const btn = e.target.closest('.menu-item-add-image');
        if (!btn) return;
        e.preventDefault();
        menuItemImagePending = { storeId: btn.getAttribute('data-store-id'), itemId: btn.getAttribute('data-item-id') };
        document.getElementById('menu-item-image-input').click();
      });
      document.getElementById('menu-item-image-input').addEventListener('change', async function () {
        if (!menuItemImagePending || !this.files || !this.files[0]) {
          menuItemImagePending = null;
          this.value = '';
          return;
        }
        const fd = new FormData();
        fd.append('file', this.files[0]);
        try {
          const r = await fetch('/api/portal/stores/' + encodeURIComponent(menuItemImagePending.storeId) + '/menu/items/' + encodeURIComponent(menuItemImagePending.itemId) + '/upload-image', { method: 'POST', credentials: 'include', body: fd });
          if (!r.ok) throw new Error(await r.text());
          await loadMenu(menuItemImagePending.storeId);
        } catch (err) {
          console.error(err);
          showToast('Failed to upload image.', 'error');
        }
        menuItemImagePending = null;
        this.value = '';
      });
      document.getElementById('refresh-orders-btn').addEventListener('click', () => {
        loadOrders(storeId).catch(err => {
          console.error(err);
          showToast('Failed to refresh orders.', 'error');
        });
      });
      document.getElementById('refresh-commands-btn').addEventListener('click', () => {
        loadCommands(storeId).catch(err => {
          console.error(err);
          showToast('Failed to refresh commands.', 'error');
        });
      });
      document.getElementById('refresh-delivery-btn').addEventListener('click', () => {
        loadDeliveryIntegrations(storeId).catch(err => {
          console.error(err);
          showToast('Failed to refresh delivery integrations.', 'error');
        });
      });

      document.getElementById('store-mobile-menu-btn').addEventListener('click', openMobileNav);
      document.getElementById('store-sidebar-overlay').addEventListener('click', closeMobileNav);
      document.getElementById('store-sidebar').querySelectorAll('a').forEach(function (a) {
        a.addEventListener('click', closeMobileNav);
      });
      document.getElementById('store-copy-key-btn').addEventListener('click', function () {
        const keyEl = document.getElementById('store-new-key-value');
        const key = keyEl && keyEl.textContent ? keyEl.textContent.trim() : '';
        if (!key) return;
        navigator.clipboard.writeText(key).then(() => showToast('Activation code copied to clipboard.', 'success')).catch(() => showToast('Copy failed. Select and copy the code by hand.', 'error'));
      });

      await loadStoreHeader(storeId);
      await loadDevices(storeId);
      await loadActivationKeys(storeId);

      const hash = (window.location.hash || '').replace('#', '');
      if (['devices', 'menu', 'orders', 'commands', 'delivery'].includes(hash)) {
        switchTab(hash);
        if (hash === 'menu') loadMenu(storeId).catch(() => {});
        else if (hash === 'orders') loadOrders(storeId).catch(() => {});
        else if (hash === 'commands') loadCommands(storeId).catch(() => {});
        else if (hash === 'delivery') loadDeliveryIntegrations(storeId).catch(() => {});
      }
    }

    init().catch(err => console.error(err));
  </script>
</body>
</html>
