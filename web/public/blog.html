<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog — Traqr Cloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet" />
  <link href="/css/output.css" rel="stylesheet" />
  <style>
    .blog-sidebar { max-height: calc(100vh - 6rem); overflow-y: auto; }
    .blog-sidebar a.active { background: #e2e8f0; color: #0f172a; font-weight: 500; }
    .blog-content pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.875rem; }
    .blog-content pre code { background: none; padding: 0; }
    .blog-content code { background: #f1f5f9; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875em; }
    .blog-content h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; padding-bottom: 0.25rem; border-bottom: 1px solid #e2e8f0; }
    .blog-content h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.25rem; }
    .blog-content p { margin-bottom: 0.75rem; }
    .blog-content ul { margin-bottom: 0.75rem; padding-left: 1.5rem; list-style: disc; }
    .blog-content ol { margin-bottom: 0.75rem; padding-left: 1.5rem; list-style: decimal; }
  </style>
</head>
<body class="min-h-screen bg-ink-100">
  <header class="border-b border-ink-200 bg-white">
    <nav class="mx-auto flex max-w-6xl items-center justify-between gap-4 px-4 py-4">
      <a href="/" class="inline-flex items-center gap-2 text-ink-900">
        <img src="/traqr.png" alt="Traqr" class="h-7 w-auto" />
        <span class="text-sm font-medium text-ink-600">Cloud</span>
      </a>
      <div class="flex items-center gap-6">
        <a href="/blog" class="text-sm font-medium text-traqr-600">Blog</a>
        <a href="/docs" class="text-sm text-ink-600 hover:text-ink-900">Docs</a>
        <a href="/dashboard" class="text-sm text-ink-600 hover:text-ink-900">Dashboard</a>
      </div>
    </nav>
  </header>

  <div class="mx-auto flex max-w-6xl gap-8 px-4 py-6">
    <aside class="w-56 shrink-0">
      <nav class="blog-sidebar sticky top-6 space-y-4 text-sm" id="blog-sidebar" aria-label="Blog navigation">
        <p class="text-ink-500">Loading…</p>
      </nav>
    </aside>

    <main class="min-w-0 flex-1">
      <nav class="mb-4 flex items-center gap-2 text-sm text-ink-500" id="blog-breadcrumbs" aria-label="Breadcrumb">
        <a href="/blog" class="hover:text-ink-700">Blog</a>
      </nav>
      <article id="blog-content" class="card blog-content">
        <p class="text-ink-500">Loading…</p>
      </article>
      <div id="blog-toast" class="mt-4 hidden rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800" role="alert"></div>
    </main>
  </div>

  <script>
    const path = window.location.pathname.replace(/^\/blog\/?/, '') || '';
    const slug = path && path !== 'new' ? path : null;
    const isNew = path === 'new';

    function escapeHtml(s) {
      if (!s) return '';
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function showBlogToast(msg) {
      const el = document.getElementById('blog-toast');
      if (!el) return;
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(function () { el.classList.add('hidden'); }, 6000);
    }

    function buildSidebar(posts, role) {
      let html = '';
      if (role === 'sa_owner' || role === 'sa_manager') {
        html += '<div class="mb-4"><div class="mb-2 text-xs font-semibold uppercase tracking-wide text-ink-500">Create</div><ul class="space-y-0.5"><li><a href="/blog/new" class="block rounded-lg px-2 py-1.5 font-medium text-traqr-600 hover:bg-traqr-50">+ New post</a></li></ul></div>';
      }
      html += '<div class="mb-4"><div class="mb-2 text-xs font-semibold uppercase tracking-wide text-ink-500">Posts</div><ul class="space-y-0.5">';
      if (!posts.length) html += '<li class="text-ink-500">No posts yet.</li>';
      else posts.forEach(function (p) {
        const active = slug === p.slug ? ' active' : '';
        html += '<li><a href="/blog/' + escapeHtml(p.slug) + '" class="block rounded-lg px-2 py-1.5 text-ink-700 hover:bg-ink-100' + active + '">' + escapeHtml(p.title) + '</a></li>';
      });
      html += '</ul></div>';
      return html;
    }

    function renderBody(body) {
      if (!body) return '';
      let html = escapeHtml(body).replace(/\n/g, '<br>');
      html = html.replace(/!\[image\]\(([^)]+)\)/g, function (_, url) { return '<img src="' + escapeHtml(url) + '" alt="" class="rounded-lg max-w-full my-2" />'; });
      html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function (_, alt, url) { return '<img src="' + (url.indexOf('/') === 0 ? (window.location.origin || '') + url : url) + '" alt="' + escapeHtml(alt) + '" class="rounded-lg max-w-full my-2" />'; });
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/~~([\s\S]*?)~~/g, '<s>$1</s>');
      return html;
    }

    async function render() {
      const sidebarEl = document.getElementById('blog-sidebar');
      const breadcrumbsEl = document.getElementById('blog-breadcrumbs');
      const contentEl = document.getElementById('blog-content');
      contentEl.innerHTML = '<p class="text-ink-500">Loading…</p>';

      try {
        const listRes = await fetch('/api/portal/blogs/public?limit=30');
        const posts = listRes.ok ? (await listRes.json()) : [];
        const postsList = Array.isArray(posts) ? posts : (posts && posts.posts) || [];
        const meRes = await fetch('/api/auth/me', { credentials: 'include' });
        const me = meRes.ok ? await meRes.json() : {};
        const role = me && me.role;
        sidebarEl.innerHTML = buildSidebar(postsList, role);

        if (slug) {
          const res = await fetch('/api/portal/blogs/by-slug/' + encodeURIComponent(slug));
          if (!res.ok) {
            contentEl.innerHTML = '<p class="text-ink-500">Post not found.</p>';
            breadcrumbsEl.innerHTML = '<a href="/blog" class="hover:text-ink-700">Blog</a><span class="text-ink-400">/</span><span>Not found</span>';
            return;
          }
          const post = await res.json();
          document.title = post.title + ' — Blog — Traqr Cloud';
          breadcrumbsEl.innerHTML = '<a href="/blog" class="hover:text-ink-700">Blog</a><span class="text-ink-400">/</span><span>' + escapeHtml(post.title) + '</span>';
          const featPath = (post.featured_image_path || '').replace(/^\//, '');
          const featImg = featPath ? '<img src="/uploads/' + escapeHtml(featPath) + '" alt="" class="mt-4 w-full rounded-lg object-cover max-h-80" />' : '';
          const bodyHtml = renderBody(post.body);
          contentEl.innerHTML = '<h1 class="font-display text-2xl font-bold text-ink-900">' + escapeHtml(post.title) + '</h1><p class="mt-2 text-sm text-ink-500">' + (post.published_at ? new Date(post.published_at).toLocaleDateString() : 'Draft') + '</p>' + featImg + '<div class="mt-6">' + bodyHtml + '</div>';
          return;
        }

        if (isNew) {
          document.title = 'New post — Blog — Traqr Cloud';
          breadcrumbsEl.innerHTML = '<a href="/blog" class="hover:text-ink-700">Blog</a><span class="text-ink-400">/</span><span>New post</span>';
          const formHtml = '<h1 class="font-display text-xl font-bold text-ink-900">New post</h1><form id="new-post-form" class="mt-4 space-y-4"><div><label class="block text-xs font-medium text-ink-700">Title</label><input type="text" id="ptitle" required class="mt-0.5 block w-full rounded-lg border border-ink-200 px-2 py-1.5 text-sm" /></div><div><label class="block text-xs font-medium text-ink-700">Excerpt (optional)</label><input type="text" id="pexcerpt" class="mt-0.5 block w-full rounded-lg border border-ink-200 px-2 py-1.5 text-sm" /></div><div><label class="block text-xs font-medium text-ink-700">Featured image (optional)</label><div class="mt-0.5 flex items-center gap-2"><input type="file" id="pfeat" accept="image/jpeg,image/png,image/gif,image/webp" class="text-sm" /><span id="pfeat-status" class="text-xs text-ink-500"></span></div><input type="hidden" id="pfeat-path" value="" /></div><div><label class="block text-xs font-medium text-ink-700">Body</label><div class="flex gap-2"><button type="button" id="pbody-insert-img" class="btn-secondary text-xs">Insert image</button><input type="file" id="pbody-img-file" accept="image/jpeg,image/png,image/gif,image/webp" class="hidden" /></div><div class="format-toolbar mt-1 flex flex-wrap items-center gap-1 rounded-t-lg border border-ink-200 border-b-0 bg-ink-50 px-2 py-1" data-target="pbody"><button type="button" class="format-btn rounded px-2 py-1 text-sm font-bold hover:bg-ink-200" data-wrap-before="**" data-wrap-after="**" title="Bold">B</button><button type="button" class="format-btn rounded px-2 py-1 text-sm italic hover:bg-ink-200" data-wrap-before="*" data-wrap-after="*" title="Italic">I</button><button type="button" class="format-btn rounded px-2 py-1 text-sm hover:bg-ink-200" data-wrap-before="[" data-wrap-after="](url)" title="Link">Link</button><button type="button" class="format-btn rounded px-2 py-1 text-sm hover:bg-ink-200" data-line-prefix="## " title="Heading">H</button><button type="button" class="format-btn rounded px-2 py-1 text-sm font-mono hover:bg-ink-200" data-wrap-before="`" data-wrap-after="`" title="Code">Code</button><button type="button" class="format-btn rounded px-2 py-1 text-sm hover:bg-ink-200" data-line-prefix="- " title="Bullet list">•</button><button type="button" class="format-btn rounded px-2 py-1 text-sm hover:bg-ink-200" data-line-prefix="1. " title="Numbered list">1.</button><button type="button" class="format-btn rounded px-2 py-1 text-sm hover:bg-ink-200" data-line-prefix="> " title="Block quote">"</button><button type="button" class="format-btn rounded px-2 py-1 text-sm hover:bg-ink-200" data-wrap-before="~~" data-wrap-after="~~" title="Strikethrough">S</button></div><textarea id="pbody" rows="8" required class="mt-0 block w-full rounded-b-lg rounded-t-none border border-ink-200 border-t-0 px-2 py-1.5 text-sm"></textarea></div><div><label class="flex items-center gap-2"><input type="checkbox" id="ppublish" /> Publish now</label></div><button type="submit" class="btn-primary text-sm">Create post</button></form>';
          contentEl.innerHTML = formHtml;
          if (role !== 'sa_owner' && role !== 'sa_manager') {
            contentEl.innerHTML = '<h1 class="font-display text-xl font-bold text-ink-900">New post</h1><p class="mt-2 text-sm text-ink-500">Only owner and manager can create posts. <a href="/blog" class="text-traqr-600">Back to blog</a></p>';
            return;
          }
          (function () {
            var featInput = document.getElementById('pfeat');
            var featPath = document.getElementById('pfeat-path');
            var featStatus = document.getElementById('pfeat-status');
            if (featInput) featInput.addEventListener('change', function () {
              if (!featInput.files || !featInput.files[0]) return;
              featStatus.textContent = 'Uploading…';
              var fd = new FormData();
              fd.append('file', featInput.files[0]);
              fetch('/api/portal/blogs/upload-image', { method: 'POST', credentials: 'include', body: fd })
                .then(function (r) {
                  if (!r.ok) return r.json().then(function (d) { throw new Error(d.message || d.detail || 'Upload failed'); });
                  return r.json();
                })
                .then(function (d) {
                  featPath.value = d.path || '';
                  featStatus.textContent = d.path ? 'Uploaded' : '';
                })
                .catch(function (err) { featStatus.textContent = err.message || 'Upload failed'; featPath.value = ''; });
            });
            var insertBtn = document.getElementById('pbody-insert-img');
            var bodyFile = document.getElementById('pbody-img-file');
            if (insertBtn && bodyFile) {
              insertBtn.addEventListener('click', function () { bodyFile.click(); });
              bodyFile.addEventListener('change', function () {
                if (!bodyFile.files || !bodyFile.files[0]) return;
                var fd = new FormData();
                fd.append('file', bodyFile.files[0]);
                fetch('/api/portal/blogs/upload-image', { method: 'POST', credentials: 'include', body: fd })
                  .then(function (r) {
                    if (!r.ok) return r.json().then(function (d) { throw new Error(d.message || d.detail || 'Upload failed'); });
                    return r.json();
                  })
                  .then(function (d) {
                    var url = d.url || (d.path ? '/uploads/' + d.path : null);
                    if (url) {
                      var ta = document.getElementById('pbody');
                      if (ta) ta.value += (ta.value ? '\n\n' : '') + '![image](' + url + ')\n\n';
                    }
                  })
                  .catch(function () { showBlogToast('Image upload failed. Make sure you are logged in as owner or manager.'); });
                bodyFile.value = '';
              });
            }
            var toolbar = document.querySelector('.format-toolbar[data-target="pbody"]');
            var ta = document.getElementById('pbody');
            if (toolbar && ta) toolbar.querySelectorAll('.format-btn').forEach(function (btn) {
              btn.addEventListener('click', function () {
                var before = btn.getAttribute('data-wrap-before'), after = btn.getAttribute('data-wrap-after');
                var linePrefix = btn.getAttribute('data-line-prefix');
                if (before !== null && after !== null) {
                  if (before === '[' && after === '](url)') {
                    var url = prompt('Link URL:', 'https://');
                    if (url != null) {
                      var start = ta.selectionStart, end = ta.selectionEnd, val = ta.value, sel = val.slice(start, end);
                      ta.value = val.slice(0, start) + '[' + sel + '](' + url + ')' + val.slice(end);
                      ta.focus();
                    }
                  } else {
                    var start = ta.selectionStart, end = ta.selectionEnd, val = ta.value, sel = val.slice(start, end);
                    ta.value = val.slice(0, start) + before + sel + after + val.slice(end);
                    ta.setSelectionRange(start + before.length, start + before.length + sel.length);
                    ta.focus();
                  }
                } else if (linePrefix) {
                  var start = ta.selectionStart, val = ta.value;
                  var lineStart = val.lastIndexOf('\n', start - 1) + 1;
                  ta.value = val.slice(0, lineStart) + linePrefix + val.slice(lineStart);
                  ta.focus();
                }
              });
            });
          })();
          document.getElementById('new-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('ptitle').value.trim();
            const featPathEl = document.getElementById('pfeat-path');
            const r = await fetch('/api/portal/blogs', {
              method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ title, slug: title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''), excerpt: document.getElementById('pexcerpt').value.trim() || null, body: document.getElementById('pbody').value, featured_image_path: featPathEl && featPathEl.value ? featPathEl.value : null, publish: document.getElementById('ppublish').checked })
            });
            if (r.ok) { const d = await r.json(); window.location.href = '/blog/' + d.slug; } else {
              const err = await r.json().catch(() => ({}));
              showBlogToast(err.message || err.detail || 'Failed to create post. You may need to log in or need owner/manager role.');
            }
          });
          return;
        }

        document.title = 'Blog — Traqr Cloud';
        breadcrumbsEl.innerHTML = '<a href="/blog" class="hover:text-ink-700">Blog</a>';
        if (!postsList.length) {
          contentEl.innerHTML = '<p class="text-ink-600">No posts yet.</p><p class="mt-2 text-sm text-ink-500"><a href="/blog/new" class="text-traqr-600 hover:underline">Create a post</a> (owner or manager only) or check back later.</p>';
          return;
        }
        contentEl.innerHTML = '<p class="text-ink-600">Select a post from the list, or browse below.</p><div class="mt-4 space-y-4">' + postsList.map(function (p) {
          return '<a href="/blog/' + escapeHtml(p.slug) + '" class="block rounded-lg border border-ink-200 bg-white p-4 hover:border-traqr-300"><h2 class="font-display text-lg font-bold text-ink-900">' + escapeHtml(p.title) + '</h2><p class="mt-1 text-sm text-ink-500">' + (p.published_at ? new Date(p.published_at).toLocaleDateString() : 'Draft') + '</p></a>';
        }).join('') + '</div>';
      } catch (err) {
        console.error('Blog render error:', err);
        contentEl.innerHTML = '<p class="text-ink-600">Something went wrong. Try refreshing or go to <a href="/dashboard" class="text-traqr-600">Dashboard</a>.</p>';
      }
    }
    render();
  </script>
</body>
</html>
