<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My profile — Traqr Cloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet" />
  <link href="/css/output.css" rel="stylesheet" />
</head>
<body class="min-h-screen bg-ink-100">
  <div class="mx-auto max-w-2xl px-4 py-8">
    <p class="text-xs text-ink-500"><a href="/dashboard" class="hover:text-ink-800">← Dashboard</a></p>
    <h1 class="mt-4 font-display text-2xl font-bold text-ink-900">My profile</h1>
    <div id="profile-error" class="mt-4 hidden rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-800"></div>
    <div id="profile-content" class="mt-6 hidden space-y-6">
      <div class="card flex flex-col items-center sm:flex-row sm:items-start gap-6">
        <div class="shrink-0">
          <img id="avatar-img" src="" alt="Avatar" class="h-24 w-24 rounded-full border-2 border-ink-200 object-cover" onerror="this.style.display='none'; document.getElementById('avatar-placeholder').style.display='flex';" />
          <div id="avatar-placeholder" class="h-24 w-24 rounded-full border-2 border-ink-200 bg-ink-100 flex items-center justify-center text-2xl text-ink-400 font-medium" style="display:none;">?</div>
        </div>
        <div class="flex-1">
          <p class="font-medium text-ink-900" id="profile-name">—</p>
          <p class="text-xs text-ink-500" id="profile-email">—</p>
          <p class="mt-2 text-xs text-ink-500" id="profile-role">—</p>
          <form id="avatar-form" class="mt-3">
            <input type="file" name="file" accept="image/jpeg,image/png,image/gif,image/webp" class="text-sm text-ink-600" />
            <button type="submit" class="btn-secondary text-xs mt-2">Upload photo</button>
          </form>
        </div>
      </div>
      <div class="card">
        <h2 class="text-sm font-semibold text-ink-900">Details</h2>
        <form id="details-form" class="mt-4 space-y-4">
          <div>
            <label for="phone" class="block text-xs font-medium text-ink-700">Phone</label>
            <input type="text" id="phone" name="phone" class="mt-0.5 block w-full rounded-lg border border-ink-200 px-2 py-1.5 text-sm" placeholder="Optional" />
          </div>
          <div>
            <label for="job_title" class="block text-xs font-medium text-ink-700">Job title</label>
            <input type="text" id="job_title" name="job_title" class="mt-0.5 block w-full rounded-lg border border-ink-200 px-2 py-1.5 text-sm" placeholder="e.g. Sales rep" />
          </div>
          <div>
            <label for="bio" class="block text-xs font-medium text-ink-700">Bio</label>
            <textarea id="bio" name="bio" rows="3" class="mt-0.5 block w-full rounded-lg border border-ink-200 px-2 py-1.5 text-sm" placeholder="Optional"></textarea>
          </div>
          <button type="submit" class="btn-primary text-sm">Save</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    async function loadMe() {
      const res = await fetch('/api/auth/me', { credentials: 'include' });
      if (res.status === 401) {
        window.location.href = '/login';
        return;
      }
      if (!res.ok) {
        document.getElementById('profile-error').textContent = 'Failed to load profile.';
        document.getElementById('profile-error').classList.remove('hidden');
        return;
      }
      const data = await res.json();
      document.getElementById('profile-content').classList.remove('hidden');
      document.getElementById('profile-name').textContent = data.display_name || data.email || '—';
      document.getElementById('profile-email').textContent = data.email || '—';
      document.getElementById('profile-role').textContent = data.role ? 'Role: ' + data.role : '—';
      document.getElementById('phone').value = data.profile?.phone || '';
      document.getElementById('job_title').value = data.profile?.job_title || '';
      document.getElementById('bio').value = data.profile?.bio || '';
      const ap = data.profile?.avatar_path;
      if (ap) {
        document.getElementById('avatar-img').src = '/uploads/' + ap;
        document.getElementById('avatar-img').style.display = '';
        document.getElementById('avatar-placeholder').style.display = 'none';
      } else {
        document.getElementById('avatar-img').style.display = 'none';
        document.getElementById('avatar-placeholder').style.display = 'flex';
      }
    }
    document.getElementById('details-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const res = await fetch('/api/portal/me', {
        method: 'PATCH',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          phone: document.getElementById('phone').value.trim() || null,
          job_title: document.getElementById('job_title').value.trim() || null,
          bio: document.getElementById('bio').value.trim() || null
        })
      });
      if (res.ok) alert('Saved.');
      else alert('Failed to save.');
    });
    document.getElementById('avatar-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.querySelector('#avatar-form input[type=file]');
      if (!input.files?.length) { alert('Choose a file'); return; }
      const fd = new FormData();
      fd.append('file', input.files[0]);
      const res = await fetch('/api/portal/me/avatar', { method: 'POST', credentials: 'include', body: fd });
      if (!res.ok) { alert('Upload failed'); return; }
      const j = await res.json();
      document.getElementById('avatar-img').src = '/uploads/' + j.avatar_path + '?t=' + Date.now();
      document.getElementById('avatar-img').style.display = '';
      document.getElementById('avatar-placeholder').style.display = 'none';
      input.value = '';
    });
    loadMe();
  </script>
</body>
</html>
