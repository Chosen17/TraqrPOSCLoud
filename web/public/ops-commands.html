<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Command Center — Traqr Cloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet" />
  <link href="/css/output.css" rel="stylesheet" />
</head>
<body class="min-h-screen bg-ink-100">
  <div class="flex min-h-screen">
    <aside class="hidden w-64 flex-col border-r border-ink-200 bg-white/90 px-4 py-6 sm:flex">
      <a href="/" class="mb-8 inline-flex items-center gap-2 text-ink-900">
        <img src="/traqr.png" alt="Traqr" class="h-8 w-auto" />
        <span class="text-sm font-medium text-ink-600">Cloud</span>
      </a>
      <nav class="space-y-1 text-sm">
        <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Main</div>
        <a href="/dashboard" class="mt-1 block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Overview</a>
        <div class="mt-4 text-xs font-semibold uppercase tracking-wide text-ink-500">Operations</div>
        <a href="/organizations" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Organizations &amp; Stores</a>
        <a href="/ops-devices" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Devices &amp; Activation</a>
        <a href="/ops-menus" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Menus &amp; Availability</a>
        <a href="/ops-orders" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Orders &amp; Receipts</a>
        <a href="/ops-commands" class="mt-1 flex items-center justify-between rounded-lg bg-ink-900 px-3 py-2 font-medium text-white">
          <span>Command Center</span>
        </a>
      </nav>
      <div class="mt-auto pt-6 text-xs text-ink-500">
        Logged in as <span id="user-name">Demo Admin</span>
      </div>
    </aside>

    <main class="flex-1">
      <header class="flex items-center justify-between border-b border-ink-200 bg-white px-4 py-3 sm:hidden">
        <div class="inline-flex items-center gap-2 text-ink-900">
          <img src="/traqr.png" alt="Traqr" class="h-7 w-auto" />
          <span class="text-sm font-medium text-ink-600">Cloud</span>
        </div>
        <span id="user-name-mobile" class="text-xs text-ink-500">Demo Admin</span>
      </header>

      <div class="mx-auto max-w-6xl px-4 py-6 sm:px-6 lg:px-8">
        <header>
          <h1 class="font-display text-2xl font-bold text-ink-900">Command Center</h1>
          <p class="mt-2 text-sm text-ink-600">
            View queued and delivered commands (void order, refund order) sent to POS devices. Commands are created from the order detail page. Select a store below to see its command queue.
          </p>
        </header>

        <div class="mt-6 rounded-xl border border-ink-200 bg-amber-50/50 px-4 py-3 text-sm text-ink-800">
          <strong>How it works:</strong> Open an order from <a href="/ops-orders" class="font-medium text-traqr-600 hover:text-traqr-500">Orders &amp; Receipts</a> or a store’s Orders tab, then use <strong>Void order</strong> or <strong>Refund order</strong>. Those actions enqueue a command here. The POS device picks up the command when it syncs and applies it locally.
        </div>

        <div class="mt-6 flex flex-col gap-6 lg:flex-row">
          <section class="w-full lg:w-1/3">
            <div class="flex items-center justify-between gap-2">
              <h2 class="text-sm font-semibold text-ink-900">Select store</h2>
              <button id="refresh-orgs-btn" class="btn-secondary text-xs">Refresh</button>
            </div>
            <p class="mt-1 text-xs text-ink-600">Choose an organization, then a store, to view its command queue.</p>
            <div id="orgs-list" class="mt-3 space-y-1 overflow-hidden rounded-xl border border-ink-200 bg-white p-2 text-sm"></div>
            <p id="orgs-empty" class="mt-3 hidden text-xs text-ink-500">No organizations yet.</p>

            <div id="stores-wrap" class="mt-4 hidden">
              <h3 class="text-xs font-semibold uppercase tracking-wide text-ink-500">Stores</h3>
              <div id="stores-list" class="mt-2 space-y-1 rounded-xl border border-ink-200 bg-white p-2 text-sm"></div>
            </div>
          </section>

          <section class="w-full lg:w-2/3">
            <h2 id="commands-heading" class="text-sm font-semibold text-ink-900">Commands</h2>
            <p id="commands-subtitle" class="mt-0.5 text-xs text-ink-600">Select a store to see queued and recent commands.</p>
            <div id="commands-panel" class="mt-4 hidden">
              <div class="flex items-center justify-between gap-2">
                <span id="commands-store-name" class="text-xs font-medium text-ink-700"></span>
                <div class="flex gap-2">
                  <a id="open-store-link" href="#" class="btn-secondary text-xs">Open store view</a>
                  <button id="refresh-commands-btn" class="btn-secondary text-xs">Refresh</button>
                </div>
              </div>
              <div class="mt-3 overflow-hidden rounded-xl border border-ink-200 bg-white">
                <table class="min-w-full divide-y divide-ink-100 text-xs">
                  <thead class="bg-ink-50 text-ink-500">
                    <tr>
                      <th class="px-3 py-2 text-left font-medium">Type</th>
                      <th class="px-3 py-2 text-left font-medium">Order (local)</th>
                      <th class="px-3 py-2 text-left font-medium">Status</th>
                      <th class="px-3 py-2 text-left font-medium">Device</th>
                      <th class="px-3 py-2 text-left font-medium">Created</th>
                    </tr>
                  </thead>
                  <tbody id="commands-body" class="divide-y divide-ink-100 bg-white"></tbody>
                </table>
                <p id="commands-empty" class="px-3 py-4 text-center text-xs text-ink-500">No commands for this store yet. Issue void or refund from an order detail page.</p>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <script>
    function setUserName(name) {
      document.getElementById('user-name').textContent = name;
      document.getElementById('user-name-mobile').textContent = name;
    }
    function formatFriendlyDateTime(v) {
      if (!v) return '–';
      const d = new Date(v);
      if (isNaN(d.getTime())) return v;
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const day = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const time = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true });
      const dateStr = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: d.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
      if (day.getTime() === today.getTime()) return 'Today ' + time;
      if (day.getTime() === yesterday.getTime()) return 'Yesterday ' + time;
      return dateStr + ', ' + time;
    }

    let selectedStoreId = null;
    let selectedStoreName = null;

    async function loadOrgs() {
      const res = await fetch('/api/portal/orgs');
      if (!res.ok) throw new Error('Failed to load organizations');
      const data = await res.json();
      const orgs = data.organizations || [];
      const list = document.getElementById('orgs-list');
      const empty = document.getElementById('orgs-empty');
      list.innerHTML = '';
      if (orgs.length === 0) {
        empty.classList.remove('hidden');
        document.getElementById('stores-wrap').classList.add('hidden');
        return;
      }
      empty.classList.add('hidden');
      orgs.forEach(org => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'flex w-full items-center justify-between rounded-lg px-3 py-2 text-left text-ink-800 hover:bg-ink-50';
        btn.dataset.orgId = org.id;
        btn.innerHTML = `<span class="font-medium">${org.name}</span><span class="text-[11px] text-ink-500">${org.store_count} stores</span>`;
        btn.addEventListener('click', () => selectOrg(org.id));
        list.appendChild(btn);
      });
    }

    async function selectOrg(orgId) {
      document.querySelectorAll('#orgs-list button').forEach(b => { b.classList.toggle('bg-ink-100', b.dataset.orgId === orgId); });
      const res = await fetch('/api/portal/orgs/' + encodeURIComponent(orgId));
      if (!res.ok) throw new Error('Failed to load organization');
      const data = await res.json();
      document.getElementById('stores-wrap').classList.remove('hidden');
      const list = document.getElementById('stores-list');
      list.innerHTML = '';
      const stores = data.stores || [];
      stores.forEach(s => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'flex w-full items-center justify-between rounded-lg px-3 py-2 text-left text-ink-800 hover:bg-ink-50';
        btn.dataset.storeId = s.id;
        btn.dataset.storeName = s.name;
        btn.innerHTML = `<span class="font-medium">${s.name}</span>`;
        btn.addEventListener('click', () => selectStore(s.id, s.name));
        list.appendChild(btn);
      });
      document.getElementById('commands-panel').classList.add('hidden');
    }

    async function selectStore(storeId, storeName) {
      selectedStoreId = storeId;
      selectedStoreName = storeName;
      document.querySelectorAll('#stores-list button').forEach(b => {
        b.classList.toggle('bg-ink-100', b.dataset.storeId === storeId);
      });
      document.getElementById('commands-heading').textContent = 'Commands — ' + storeName;
      document.getElementById('commands-subtitle').textContent = 'Queued and recent void/refund commands for this store.';
      document.getElementById('commands-panel').classList.remove('hidden');
      document.getElementById('commands-store-name').textContent = storeName;
      document.getElementById('open-store-link').href = '/store.html?store_id=' + encodeURIComponent(storeId) + '#commands';
      await loadCommands(storeId);
    }

    async function loadCommands(storeId) {
      if (!storeId) return;
      const res = await fetch('/api/portal/stores/' + encodeURIComponent(storeId) + '/commands');
      if (!res.ok) throw new Error('Failed to load commands');
      const data = await res.json();
      const commands = data.commands || [];
      const body = document.getElementById('commands-body');
      const empty = document.getElementById('commands-empty');
      body.innerHTML = '';
      if (commands.length === 0) {
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        commands.forEach(c => {
          const tr = document.createElement('tr');
          const statusClass = c.status === 'acked' ? 'bg-emerald-50 text-emerald-700' : c.status === 'failed' ? 'bg-rose-50 text-rose-700' : 'bg-amber-50 text-amber-800';
          tr.innerHTML = `
            <td class="px-3 py-2 text-ink-800">${c.command_type}${c.sensitive ? ' <span class="text-[10px] text-ink-500">(sensitive)</span>' : ''}</td>
            <td class="px-3 py-2 font-mono text-[11px] text-ink-700">${c.local_order_id || '—'}</td>
            <td class="px-3 py-2"><span class="inline-flex rounded-full px-2 py-0.5 text-[11px] font-medium ${statusClass}">${c.status}</span></td>
            <td class="px-3 py-2 font-mono text-[11px] text-ink-500">${(c.device_id || '').slice(0, 8)}…</td>
            <td class="px-3 py-2 text-ink-500">${formatFriendlyDateTime(c.created_at)}</td>
          `;
          body.appendChild(tr);
        });
      }
    }

    (function init() {
      try { const n = window.localStorage.getItem('traqr_display_name'); if (n) setUserName(n); } catch (_) {}
      document.getElementById('refresh-orgs-btn').addEventListener('click', () => loadOrgs().catch(e => { console.error(e); alert('Failed to refresh.'); }));
      document.getElementById('refresh-commands-btn').addEventListener('click', () => {
        if (selectedStoreId) loadCommands(selectedStoreId).catch(e => { console.error(e); alert('Failed to refresh commands.'); });
      });
      loadOrgs().catch(e => console.error(e));
    })();
  </script>
</body>
</html>
