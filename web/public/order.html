<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order — Traqr Cloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet" />
  <link href="/css/output.css" rel="stylesheet" />
</head>
<body class="min-h-screen bg-ink-100">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="hidden w-64 flex-col border-r border-ink-200 bg-white/90 px-4 py-6 sm:flex">
      <a href="/" class="mb-8 inline-flex items-center gap-2 text-ink-900">
        <img src="/traqr.png" alt="Traqr" class="h-8 w-auto" />
        <span class="text-sm font-medium text-ink-600">Cloud</span>
      </a>
      <nav class="space-y-1 text-sm">
        <div class="text-xs font-semibold uppercase tracking-wide text-ink-500">Main</div>
        <a href="/dashboard" class="mt-1 block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Overview</a>
        <div class="mt-4 text-xs font-semibold uppercase tracking-wide text-ink-500">Operations</div>
        <a href="/organizations" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Organizations &amp; Stores</a>
        <a href="/ops-devices" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Devices &amp; Activation</a>
        <a href="/ops-menus" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Menus &amp; Availability</a>
        <a href="/ops-orders" class="mt-1 flex items-center justify-between rounded-lg bg-ink-900 px-3 py-2 font-medium text-white">
          <span>Orders &amp; Receipts</span>
        </a>
        <a href="/ops-commands" class="block rounded-lg px-3 py-2 text-ink-700 hover:bg-ink-100">Command Center</a>
      </nav>
      <div class="mt-auto pt-6 text-xs text-ink-500">
        Logged in as <span id="user-name">Demo Admin</span>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1">
      <!-- Top bar (mobile) -->
      <header class="flex items-center justify-between border-b border-ink-200 bg-white px-4 py-3 sm:hidden">
        <div class="inline-flex items-center gap-2 text-ink-900">
          <img src="/traqr.png" alt="Traqr" class="h-7 w-auto" />
          <span class="text-sm font-medium text-ink-600">Cloud</span>
        </div>
        <div class="text-xs text-ink-500">
          <span id="user-name-mobile">Demo Admin</span>
        </div>
      </header>

      <div class="mx-auto max-w-6xl px-4 py-6 sm:px-6 lg:px-8">
        <header class="flex items-center justify-between gap-4">
          <div>
            <p id="order-breadcrumb" class="text-xs text-ink-500">
              <a href="/ops-orders" class="hover:text-ink-800">Orders</a>
              <span>/</span>
              <span id="order-store-label">Order</span>
            </p>
            <h1 class="mt-1 font-display text-2xl font-bold text-ink-900">
              Order <span id="order-local-id" class="font-mono text-base text-ink-700">—</span>
            </h1>
            <p id="order-meta" class="mt-1 text-sm text-ink-600">Status · Total · Date</p>
          </div>
          <div class="flex flex-col items-end gap-1 text-xs">
            <div id="order-status-badge"></div>
            <div id="order-occurred-at" class="text-ink-500"></div>
          </div>
        </header>

        <section class="mt-6 grid gap-4 lg:grid-cols-[minmax(0,2fr),minmax(260px,1fr)]">
          <!-- Left: items -->
          <div class="space-y-4">
            <div class="card">
              <div class="flex items-center justify-between">
                <h2 class="text-sm font-semibold text-ink-900">Items</h2>
                <p id="order-total" class="text-sm font-semibold text-ink-900">–</p>
              </div>
              <div id="order-items" class="mt-3 divide-y divide-ink-100"></div>
              <p id="order-items-empty" class="mt-2 text-xs text-ink-500">
                No items recorded for this order.
              </p>
              <p id="order-sync-hint" class="mt-3 hidden rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-900">
                <strong>This order is in the cloud.</strong> Line items and receipts will show here once the till syncs them. The till must send <code class="rounded bg-amber-100 px-1">order_created</code> (with an <code class="rounded bg-amber-100 px-1">items</code> array) and <code class="rounded bg-amber-100 px-1">receipt_created</code> events. Trigger sync on the till, then refresh this page.
              </p>
            </div>

            <div class="card">
              <h2 class="text-sm font-semibold text-ink-900">Receipts</h2>
              <div id="order-receipts" class="mt-3 space-y-2 text-xs"></div>
              <p id="order-receipts-empty" class="mt-2 text-xs text-ink-500">
                No receipts synced yet.
              </p>
            </div>
          </div>

          <!-- Right: payments & actions -->
          <div class="space-y-4">
            <div class="card">
              <h2 class="text-sm font-semibold text-ink-900">Payments</h2>
              <div id="order-transactions" class="mt-3 space-y-2 text-xs"></div>
              <p id="order-transactions-empty" class="mt-2 text-xs text-ink-500">
                No payments recorded yet.
              </p>
            </div>

            <div class="card">
              <h2 class="text-sm font-semibold text-ink-900">Command Center</h2>
              <p class="mt-1 text-xs text-ink-600">
                Enqueue a void or refund command for this order. The POS device will pick it up on the next sync.
              </p>
              <div class="mt-3 flex flex-col gap-2 text-sm">
                <button id="void-order-btn" class="btn-secondary">Void order</button>
                <button id="refund-order-btn" class="btn-secondary">Refund order</button>
              </div>
              <p id="order-command-message" class="mt-2 text-xs text-ink-500"></p>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function setUserName(name) {
      document.getElementById('user-name').textContent = name;
      document.getElementById('user-name-mobile').textContent = name;
    }

    function formatMoney(cents) {
      if (cents == null) return '–';
      const value = (cents / 100).toFixed(2);
      return '£' + value;
    }

    function formatDateTime(value) {
      if (!value) return '–';
      return value.replace('T', ' ');
    }
    function formatFriendlyDateTime(value) {
      if (!value) return '–';
      const d = new Date(value);
      if (isNaN(d.getTime())) return value;
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const day = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const time = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true });
      const dateStr = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: d.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
      if (day.getTime() === today.getTime()) return 'Today ' + time;
      if (day.getTime() === yesterday.getTime()) return 'Yesterday ' + time;
      return dateStr + ', ' + time;
    }

    async function loadOrder(orderId) {
      const res = await fetch(`/api/portal/orders/${encodeURIComponent(orderId)}`);
      if (!res.ok) throw new Error('Failed to load order');
      const data = await res.json();

      const localId = (data.local_order_id || '').trim() || '—';
      document.getElementById('order-local-id').textContent = localId;
      const status = (data.status || 'open').toLowerCase();
      const totalStr = formatMoney(data.total_cents);
      const dateStr = formatFriendlyDateTime(data.occurred_at);
      document.getElementById('order-meta').textContent =
        `${status} · ${totalStr} · ${dateStr}`;
      document.getElementById('order-occurred-at').textContent =
        dateStr;
      document.getElementById('order-total').textContent = totalStr;
      document.getElementById('order-store-label').textContent = 'Order';

      const statusBadge = document.getElementById('order-status-badge');
      const statusClass =
        data.status === 'open'
          ? 'bg-amber-50 text-amber-800'
          : data.status === 'closed'
          ? 'bg-emerald-50 text-emerald-800'
          : 'bg-ink-50 text-ink-700';
      statusBadge.innerHTML = `
        <span class="inline-flex rounded-full px-2 py-0.5 text-[11px] font-medium ${statusClass}">
          ${data.status}
        </span>
      `;

      const itemsContainer = document.getElementById('order-items');
      const itemsEmpty = document.getElementById('order-items-empty');
      itemsContainer.innerHTML = '';
      const hasItems = data.items && data.items.length > 0;
      const hasReceipts = data.receipts && data.receipts.length > 0;
      const hasPayments = data.transactions && data.transactions.length > 0;
      const syncHint = document.getElementById('order-sync-hint');
      if (syncHint) syncHint.classList.toggle('hidden', hasItems && hasReceipts);
      if (!hasItems) {
        itemsEmpty.classList.remove('hidden');
      } else {
        itemsEmpty.classList.add('hidden');
        for (const item of data.items) {
          const div = document.createElement('div');
          div.className = 'flex items-center justify-between gap-2 px-3 py-2';
          div.innerHTML = `
            <div>
              <div class="text-xs font-medium text-ink-900">${item.product_ref || item.local_item_id || 'Item'}</div>
              <div class="mt-0.5 text-[11px] text-ink-500">Qty ${item.quantity}</div>
            </div>
            <div class="text-right text-xs text-ink-900">
              <div>${formatMoney(item.unit_price_cents)}</div>
              <div class="mt-0.5 text-[11px] text-ink-500">${formatMoney(item.line_total_cents)}</div>
            </div>
          `;
          itemsContainer.appendChild(div);
        }
      }

      const txContainer = document.getElementById('order-transactions');
      const txEmpty = document.getElementById('order-transactions-empty');
      txContainer.innerHTML = '';
      if (!data.transactions || data.transactions.length === 0) {
        txEmpty.classList.remove('hidden');
      } else {
        txEmpty.classList.add('hidden');
        for (const t of data.transactions) {
          const div = document.createElement('div');
          div.className = 'flex items-center justify-between rounded-lg border border-ink-100 bg-ink-50/60 px-3 py-2';
          div.innerHTML = `
            <div>
              <div class="text-xs font-medium text-ink-900">${t.kind}</div>
              <div class="mt-0.5 text-[11px] text-ink-500">${formatFriendlyDateTime(t.occurred_at)}</div>
            </div>
            <div class="text-xs font-semibold text-ink-900">${formatMoney(t.amount_cents)}</div>
          `;
          txContainer.appendChild(div);
        }
      }

      const rcContainer = document.getElementById('order-receipts');
      const rcEmpty = document.getElementById('order-receipts-empty');
      rcContainer.innerHTML = '';
      if (!data.receipts || data.receipts.length === 0) {
        rcEmpty.classList.remove('hidden');
      } else {
        rcEmpty.classList.add('hidden');
        for (const r of data.receipts) {
          const div = document.createElement('div');
          div.className = 'rounded-lg border border-ink-100 bg-ink-50/60 px-3 py-2';
          div.innerHTML = `
            <div class="text-xs font-medium text-ink-900">Receipt ${r.local_receipt_id}</div>
            <div class="mt-0.5 text-[11px] text-ink-500">${formatFriendlyDateTime(r.occurred_at)}</div>
          `;
          rcContainer.appendChild(div);
        }
      }

      return data;
    }

    async function enqueueCommand(orderId, commandType) {
      const msg = document.getElementById('order-command-message');
      msg.textContent = '';
      const res = await fetch(`/api/portal/orders/${encodeURIComponent(orderId)}/commands`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command_type: commandType })
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || 'Failed to enqueue command');
      }
      const data = await res.json();
      msg.textContent = `Enqueued ${commandType} command (${data.command_id}). It will be delivered on next device sync.`;
    }

    async function init() {
      const orderId = getQueryParam('order_id');
      if (!orderId) {
        alert('Missing order_id in URL');
        return;
      }
      try {
        const storedName = window.localStorage.getItem('traqr_display_name');
        if (storedName) setUserName(storedName);
      } catch (_) {}

      const data = await loadOrder(orderId);

      document.getElementById('void-order-btn').addEventListener('click', async () => {
        if (!confirm('Enqueue a void_order command for this order?')) return;
        try {
          await enqueueCommand(orderId, 'void_order');
        } catch (err) {
          console.error(err);
          alert('Failed to enqueue void order command.');
        }
      });
      document.getElementById('refund-order-btn').addEventListener('click', async () => {
        if (!confirm('Enqueue a refund_order command for this order?')) return;
        try {
          await enqueueCommand(orderId, 'refund_order');
        } catch (err) {
          console.error(err);
          alert('Failed to enqueue refund order command.');
        }
      });
    }

    init().catch(err => console.error(err));
  </script>
</body>
</html>

